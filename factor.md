# 特征工程因子目录 (Factor Catalog V4)

基于OHLCV数据的分钟级特征库,专注于K线形态和价量关系分析。

---

## 1. 流动性因子 (Liquidity Factors)

流动性因子衡量市场的交易活跃度和价格冲击成本,反映资金进出的难易程度。

### 成交量加权价格因子

- **WAP** (Weighted Average Price) - 加权平均价格
  - 公式: `WAP = (∑(价格_i × 数量_i)) / ∑数量_i`
  - 作用: 衡量真实成交的平均价格,反映市场参与者的实际成交成本,常用于订单簿分析

- **VWAP** (Volume Weighted Average Price) - 成交量加权平均价格
  - 公式: `VWAP = (∑(价格_i × 成交量_i)) / ∑成交量_i`
  - 作用: 衡量时间段内的平均成交价格,机构交易的重要基准,作为支撑/阻力位参考

### 对数收益率因子

- **Log_Return_WAP_1** - WAP对数收益率(1期)
  - 公式: `log_return_wap_1 = ln(WAP_t / WAP_{t-1})`
  - 作用: 衡量基于WAP的短期价格变动,对数形式更适合统计分析和模型训练

- **Log_Return_WAP_2** - WAP对数收益率(2期)
  - 公式: `log_return_wap_2 = ln(WAP_t / WAP_{t-2})`
  - 作用: 捕捉稍长周期的WAP价格动量,用于识别短期趋势延续或反转

### 成交量趋势因子

- **Volume_Trend_60** - 60期成交量趋势指标
  - 公式: `volume_trend_60 = (Volume_t - MA(Volume, 60)) / Std(Volume, 60)`
  - 作用: 标准化的成交量偏离度,识别异常放量或缩量,值>2表示显著放量,值<-2表示显著缩量

---

## 2. K线形态因子 (Candlestick Pattern Factors)

K线形态因子捕捉蜡烛图的几何特征,反映市场多空力量对比和投资者情绪。

### 基础形态特征

- **KMID** - K线中间价位置
  - 公式: `kmid = (close - open) / (high - low + ε)`
  - 作用: 衡量K线实体在整体波动范围中的位置,值>0表示收盘价高于开盘价(阳线),值<0表示阴线
  - 解释: kmid ≈ 1表示全实体大阳线,kmid ≈ -1表示全实体大阴线,kmid ≈ 0表示十字星

- **KLEN** - K线长度(相对波动)比例
  - 公式: `klen = (high - low) / (open + ε)`
  - 作用: 衡量K线整体波动幅度相对于开盘价的比例,反映市场波动强度
  - 解释: 值越大表示波动越剧烈,适用于识别关键转折点或突破

- **KUP** - 上影线比例
  - 公式: `kup = (high - max(open, close)) / (high - low + ε)`
  - 作用: 衡量上影线在整体波动范围中的占比,反映上方抛压强度
  - 解释: 值越大表示上方卖压越重,可能预示上涨乏力或顶部反转

- **KLOW** - 下影线比例
  - 公式: `klow = (min(open, close) - low) / (high - low + ε)`
  - 作用: 衡量下影线在整体波动范围中的占比,反映下方承接力度
  - 解释: 值越大表示下方买盘越强,可能预示下跌受阻或底部反转

- **KSFT** - K线实体偏移度
  - 公式: `ksft = (max(open, close) - (high + low)/2) / (high - low + ε)`
  - 作用: 衡量K线实体相对于高低价中点的偏移程度,反映多空力量的空间分布
  - 解释: 值>0表示实体偏向上方(买方占优),值<0表示实体偏向下方(卖方占优)

### 非线性增强特征

- **KMID2** - K线中间价位置平方项
  - 公式: `kmid2 = kmid²`
  - 作用: 增强kmid的非线性特征,放大极端值的影响,帮助模型捕捉大阳线/大阴线的信号

- **KUP2** - 上影线比例平方项
  - 公式: `kup2 = kup²`
  - 作用: 增强上影线的非线性关系,强化长上影线的反转信号

- **KLOW2** - 下影线比例平方项
  - 公式: `klow2 = klow²`
  - 作用: 增强下影线的非线性关系,强化长下影线的支撑信号

- **KSFT2** - K线实体偏移度平方项
  - 公式: `ksft2 = ksft²`
  - 作用: 增强实体偏移的非线性特征,放大多空力量失衡的影响

---

## 3. K线形态识别参考表

以下是常见K线形态的特征值范围及其市场含义:

| 形态名称 | kmid | kup | klow | ksft | 市场含义 |
|---------|------|-----|------|------|---------|
| **大阳线** | >0.7 | 小(<0.2) | 小(<0.2) | >0.3 | 强烈看涨,买方主导 |
| **大阴线** | <-0.7 | 小(<0.2) | 小(<0.2) | <-0.3 | 强烈看跌,卖方主导 |
| **十字星** | ≈0 (±0.1) | ≈0.5 (±0.1) | ≈0.5 (±0.1) | ≈0 (±0.1) | 市场犹豫,方向不明 |
| **锤子线** | >0 | 小(<0.2) | >0.7 | <0 | 底部反转信号,下方支撑强 |
| **射击之星** | <0 | >0.7 | 小(<0.2) | >0 | 顶部反转信号,上方压力大 |
| **纺锤线** | ≈0 (±0.1) | ≈0.3 (±0.1) | ≈0.3 (±0.1) | ≈0 (±0.1) | 平衡市场,震荡行情 |

### 形态组合策略建议

1. **趋势确认**: 大阳线/大阴线配合成交量放大,确认趋势延续
2. **反转识别**: 锤子线/射击之星出现在趋势末端,结合RSI超买超卖信号
3. **震荡判断**: 连续出现十字星/纺锤线,适合均值回归策略
4. **多因子验证**: K线形态因子应与动量、波动率因子结合使用,提高信号可靠性

---

## 4. 基础数据字段 (Base OHLCV Data)

- **timestamp**: 时间戳
- **open**: 开盘价
- **high**: 最高价
- **low**: 最低价
- **close**: 收盘价
- **volume**: 成交量

---

## 使用建议

### 特征工程注意事项

1. **异常值处理**:
   - K线形态因子中使用了 ε (epsilon, 通常取1e-8) 避免除零错误
   - 建议对所有比率型因子进行clip处理,限制在合理范围内

2. **特征标准化**:
   - 对数收益率通常服从正态分布,可直接使用
   - K线形态因子已归一化到[-1, 1]或[0, 1]范围,无需额外标准化
   - Volume_Trend_60已进行Z-score标准化

3. **特征组合**:
   - K线形态因子(kmid, kup, klow, ksft)应组合使用,单一因子可能产生虚假信号
   - 平方项因子帮助非线性模型(如神经网络)更好地学习复杂模式
   - WAP/VWAP配合对数收益率,可构建更稳健的价格动量指标

4. **时间窗口考虑**:
   - 可构建多时间窗口的K线形态因子(5分钟、15分钟、60分钟)
   - 不同周期的形态因子可作为独立特征输入模型

### 因子有效性检验

- 计算K线形态因子与未来收益的IC (Information Coefficient)
- 检验形态因子在不同市场状态(趋势/震荡)下的稳定性
- 分析形态因子与成交量因子的交互效应

---

## 附录: 原始特征列表

```python
# 基础OHLCV数据
'timestamp', 'volume', 'open', 'high', 'low', 'close'

# 价格加权因子
'log_return_wap_1'
'log_return_wap_2'

# 成交量趋势
'volume_trend_60'

# K线形态因子
'kmid'   # K线中间价位置
'klen'   # K线长度比例
'kup'    # 上影线比例
'klow'   # 下影线比例
'ksft'   # K线实体偏移度

# 非线性平方项
'kmid2'
'kup2'
'klow2'
'ksft2'
```
